<!DOCTYPE html>
<html>
<head>
    <title>Export Dispatch System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .btn { margin: 2px; }
        .status-badge { font-size: 0.8em; }
        .summary-card { 
            transition: transform 0.2s; 
            cursor: pointer;
        }
        .summary-card:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .summary-card.active { 
            border-width: 3px;
            transform: translateY(-2px);
        }
        .card-title { font-size: 0.9rem; margin-bottom: 0.5rem; }
        .count-display { font-size: 1.5rem; font-weight: bold; }
        .table th { background-color: #343a40; color: white; }
        .sort-indicator { font-size: 0.7em; margin-left: 5px; }
        .loading-date-urgent { background-color: #fff3cd !important; } /* Yellow for upcoming loading */
        .loading-date-past { background-color: #f8d7da !important; } /* Red for past loading dates */
    </style>

    <!-- Add this at the top of your home.html template, right after the body tag -->
{% if messages %}
<div class="container mt-3">
    {% for message in messages %}
    <div class="alert alert-dismissible alert-{{ message.tags }} show" role="alert">
        <div class="d-flex align-items-center">
            {% if message.tags == 'success' %}
            <i class="fas fa-check-circle me-2"></i>
            {% elif message.tags == 'error' %}
            <i class="fas fa-exclamation-circle me-2"></i>
            {% endif %}
            <div class="flex-grow-1">{{ message }}</div>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Export Dispatch System</h1>
            <div class="d-flex gap-2 align-items-center">
                <div>
                    <a href="{% url 'reports' %}" class="btn btn-warning">üìä Reports</a>
                    <a href="{% url 'dispatch_create' %}" class="btn btn-primary">Create New Dispatch</a>
                        {% if user.is_superuser %}
                            <a href="{% url 'customer_list' %}" class="btn btn-success">Manage Customers</a>
                            <a href="{% url 'product_list' %}" class="btn btn-info">Manage Products</a>
                        {% endif %}
                </div>
                <div class="ms-3 ps-3 border-start">
                    <span class="me-2">{{ user.username }}</span>
                    <form method="post" action="{% url 'logout' %}" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-outline-danger btn-sm">Logout</button>
                    </form>
                </div>
            </div>
        </div>



        <!-- Export Summary Section -->
        <div class="row mb-4">
            <!-- Total Export Card -->
            <div class="col-md-3 mb-3">
                <div class="card summary-card border-primary {% if not current_status and not current_sort %}active{% endif %}" 
                     onclick="window.location='?sort_by=delivery'">
                    <div class="card-body text-center">
                        <h5 class="card-title text-primary">Total Export</h5>
                        <div class="count-display text-primary">{{ total_export }}</div>
                        <small class="text-muted">Dispatch Orders</small>
                        {% if not current_status and not current_sort %}
                        <div class="sort-indicator text-success">‚úì Sorted by Delivery Date (Newest First)</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Status-wise Export Cards -->
            <div class="col-md-9">
                <div class="row">
                    <div class="col-md-2 mb-3">
                        <a href="?status=draft" class="text-decoration-none">
                            <div class="card summary-card border-secondary {% if current_status == 'draft' %}active{% endif %}">
                                <div class="card-body text-center p-2">
                                    <h6 class="card-title">Draft</h6>
                                    <div class="count-display text-secondary">{{ status_counts.draft }}</div>
                                    {% if current_status == 'draft' %}
                                    <div class="sort-indicator text-success">‚úì Sorted by Loading Date</div>
                                    {% endif %}
                                </div>
                            </div>
                        </a>
                    </div>
                    
                    <div class="col-md-2 mb-3">
                        <a href="?status=confirmed" class="text-decoration-none">
                            <div class="card summary-card border-primary {% if current_status == 'confirmed' %}active{% endif %}">
                                <div class="card-body text-center p-2">
                                    <h6 class="card-title">Confirmed</h6>
                                    <div class="count-display text-primary">{{ status_counts.confirmed }}</div>
                                </div>
                            </div>
                        </a>
                    </div>
                    
                    <div class="col-md-2 mb-3">
                        <a href="?status=shipped" class="text-decoration-none">
                            <div class="card summary-card border-warning {% if current_status == 'shipped' %}active{% endif %}">
                                <div class="card-body text-center p-2">
                                    <h6 class="card-title">Shipped</h6>
                                    <div class="count-display text-warning">{{ status_counts.shipped }}</div>
                                </div>
                            </div>
                        </a>
                    </div>
                    
                    <div class="col-md-2 mb-3">
                        <a href="?status=delivered" class="text-decoration-none">
                            <div class="card summary-card border-success {% if current_status == 'delivered' %}active{% endif %}">
                                <div class="card-body text-center p-2">
                                    <h6 class="card-title">Delivered</h6>
                                    <div class="count-display text-success">{{ status_counts.delivered }}</div>
                                </div>
                            </div>
                        </a>
                    </div>
                    
                    <div class="col-md-2 mb-3">
                        <a href="?status=cancelled" class="text-decoration-none">
                            <div class="card summary-card border-danger {% if current_status == 'cancelled' %}active{% endif %}">
                                <div class="card-body text-center p-2">
                                    <h6 class="card-title">Cancelled</h6>
                                    <div class="count-display text-danger">{{ status_counts.cancelled }}</div>
                                </div>
                            </div>
                        </a>
                    </div>
                    
                    <div class="col-md-2 mb-3">
                        <a href="?" class="text-decoration-none">
                            <div class="card summary-card border-info {% if not current_status %}active{% endif %}">
                                <div class="card-body text-center p-2">
                                    <h6 class="card-title">Show All</h6>
                                    <div class="count-display text-info">{{ total_export }}</div>
                                    {% if not current_status %}
                                    <div class="sort-indicator text-success">‚úì Sorted by Delivery Date</div>
                                    {% endif %}
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Current Filter Info -->
        {% if current_status %}
        <div class="alert alert-info d-flex justify-content-between align-items-center">
            <div>
                <strong>Currently viewing:</strong> 
                <span class="badge 
                    {% if current_status == 'draft' %}bg-secondary
                    {% elif current_status == 'confirmed' %}bg-primary
                    {% elif current_status == 'shipped' %}bg-warning
                    {% elif current_status == 'delivered' %}bg-success
                    {% else %}bg-danger{% endif %}">
                    {{ current_status|title }}
                </span>
                {% if current_status == 'draft' %}
                <span class="ms-2">- Sorted by Loading Date (Oldest First) to show pending loads</span>
                {% endif %}
            </div>
            <a href="?" class="btn btn-sm btn-outline-info">Clear Filter</a>
        </div>
        {% endif %}
        <!-- Search Box -->
        <div class="mb-4">
            <div class="input-group">
                <span class="input-group-text">üîç</span>
                <input 
                    type="text" 
                    id="order-search" 
                    class="form-control" 
                    placeholder="Search by Order No (e.g., type any part of the number)..."
                >
                <button class="btn btn-outline-secondary" type="button" id="clear-search">Clear</button>
            </div>
            <small class="text-muted mt-1">Tip: Type any letters or numbers from the Order No.</small>
        </div>
        <h2>All Dispatches</h2>
        
        {% if dispatches %}
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Dispatch ID</th>
                        <th>Order No</th>
                        <th>Customer</th>
                        <th>Order Date</th>
                        <th>
                            Loading Date
                            {% if current_status == 'draft' %}
                            <span class="sort-indicator text-warning">‚Üë Oldest First</span>
                            {% endif %}
                        </th>
                        <th>
                            Delivery Date
                            {% if not current_status %}
                            <span class="sort-indicator text-warning">‚Üì Newest First</span>
                            {% endif %}
                        </th>
                        <th>Items</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <!-- In home.html, replace the <tbody> section -->
                <tbody>
                    {% for dispatch in dispatches %}
                    <tr class="{% if dispatch.Status == 'draft' %}{% if dispatch.LoadingDate and dispatch.LoadingDate < today %}loading-date-past{% elif dispatch.LoadingDate and dispatch.LoadingDate <= soon_date %}loading-date-urgent{% endif %}{% endif %}">
                        <td><strong>{{ dispatch.DispatchID }}</strong></td>
                        <td>{{ dispatch.OrderNo }}</td>
                        <td class="d-none d-md-table-cell">{{ dispatch.Customer.Customer }}</td>
                        <td class="d-none d-md-table-cell">{{ dispatch.OrderDate }}</td>
                        <td class="d-none d-md-table-cell">
                            {% if dispatch.LoadingDate %}
                                {{ dispatch.LoadingDate }}
                                {% if dispatch.Status == 'draft' %}
                                    {% if dispatch.LoadingDate < today %}
                                    <span class="badge bg-danger ms-1 d-none d-lg-inline">Overdue</span>
                                    {% elif dispatch.LoadingDate <= soon_date %}
                                    <span class="badge bg-warning ms-1 d-none d-lg-inline">Soon</span>
                                    {% endif %}
                                {% endif %}
                            {% else %}
                                <span class="text-muted">Not set</span>
                            {% endif %}
                        </td>
                        <td class="d-none d-md-table-cell">
                            {% if dispatch.DeliveryDate %}
                                {{ dispatch.DeliveryDate }}
                            {% else %}
                                <span class="text-muted">Not set</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <span class="badge bg-secondary">
                                {{ dispatch.details.count }} items
                            </span>
                        </td>
                        <td>
                            <span class="badge 
                                {% if dispatch.Status == 'draft' %}bg-secondary
                                {% elif dispatch.Status == 'confirmed' %}bg-primary
                                {% elif dispatch.Status == 'shipped' %}bg-warning
                                {% elif dispatch.Status == 'delivered' %}bg-success
                                {% else %}bg-danger{% endif %} status-badge">
                                {{ dispatch.Status|title }}
                            </span>
                        </td>
                        <td>
                            <!-- Desktop: Full button group -->
                            <div class="btn-group d-none d-md-inline-flex" role="group">
                                <a href="{% url 'dispatch_note' dispatch.DispatchID %}" class="btn btn-info btn-sm" title="View Dispatch Note">
                                    üìÑ View
                                </a>
                                <a href="{% url 'dispatch_edit' dispatch.DispatchID %}" class="btn btn-warning btn-sm" title="Edit">
                                    ‚úèÔ∏è Edit
                                </a>
                                {% if dispatch.details.exists %}
                                    <a href="{% url 'loading_sheet' dispatch.DispatchID %}" class="btn btn-secondary btn-sm" title="Print Loading Sheet" target="_blank">
                                        üì¶ Loading
                                    </a>
                                {% endif %}
                                {% if user.is_superuser %}
                                    <a href="{% url 'dispatch_delete' dispatch.DispatchID %}" class="btn btn-danger btn-sm" title="Delete">
                                        üóëÔ∏è Delete
                                    </a>
                                {% endif %}
                            </div>
                            
                            <!-- Mobile: "More" dropdown -->
                            <div class="d-md-none">
                                <div class="dropdown">
                                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                        ‚ãÆ
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="{% url 'dispatch_note' dispatch.DispatchID %}">üìÑ View</a></li>
                                        <li><a class="dropdown-item" href="{% url 'dispatch_edit' dispatch.DispatchID %}">‚úèÔ∏è Edit</a></li>
                                        {% if dispatch.details.exists %}
                                            <li><a class="dropdown-item" href="{% url 'loading_sheet' dispatch.DispatchID %}" target="_blank">üì¶ Loading Sheet</a></li>
                                        {% endif %}
                                        {% if user.is_superuser %}
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item text-danger" href="{% url 'dispatch_delete' dispatch.DispatchID %}">üóëÔ∏è Delete</a></li>
                                        {% endif %}
                                    </ul>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info">
            <p>No dispatches found. <a href="{% url 'dispatch_create' %}" class="alert-link">Create your first dispatch</a></p>
        </div>
        {% endif %}
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('order-search');
    const clearBtn = document.getElementById('clear-search');
    const rows = document.querySelectorAll('tbody tr'); // ‚úÖ Simpler selector

    // Live search as you type
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.trim().toLowerCase();
        let visibleCount = 0;

        rows.forEach(row => {
            // Order No is in the 2nd <td> (index 1)
            const orderNoCell = row.cells[1]; // ‚úÖ Direct access to 2nd column
            if (orderNoCell) {
                const orderNo = orderNoCell.textContent.trim().toLowerCase();
                if (orderNo.includes(searchTerm)) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            }
        });

        // Optional: Show "No results" message
        if (visibleCount === 0 && searchTerm !== '') {
            showMessage(`No orders found matching "${searchTerm}"`, 'info');
        }
    });

    // Clear search
    clearBtn.addEventListener('click', function() {
        searchInput.value = '';
        // Trigger input event to show all rows
        searchInput.dispatchEvent(new Event('input'));
    });

    // Show temporary message
    function showMessage(message, type) {
        // Remove existing message
        const existing = document.querySelector('.search-alert');
        if (existing) existing.remove();

        const alert = document.createElement('div');
        alert.className = `alert alert-${type} search-alert alert-dismissible fade show mt-2`;
        alert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.querySelector('.input-group').parentNode.insertAdjacentElement('afterend', alert);
        setTimeout(() => {
            if (alert.parentNode) alert.remove();
        }, 3000);
    }
});
</script>
</body>
</html>